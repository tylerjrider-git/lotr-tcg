<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTR TCG Prototype</title>
    <style>
        canvas {
            border: 2px solid black;
        }
    </style>
      <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1 id="loginGreeting">Welcome to the TestApp </h1>
    <h2 id="gameIdHeading">GameId:</h2>
    <h2 id="opponentNameHeading">Opponent:</h2>
    <script>
        window.onload = function () {
            const playerInfo = sessionStorage.getItem("playerName");
            const gameId = sessionStorage.getItem("gameID");
            const heading = document.getElementById("loginGreeting");
            if (playerInfo) {
                heading.innerText = "Welcome to the LOTR TCG " + playerInfo;
            }
            const gameIdHeading = document.getElementById("gameIdHeading")
            gameIdHeading.innerText = "GameId:" + gameId;
        };
    </script>

    <h1></h1>

    <div id="waitingPopup" class="popup">
        <div class="popup-content">
            <p>Waiting for another player to join...</p>
            <div class="spinner"></div>
        </div>
    </div>

    <canvas id="gameCanvas" style="width: 100%; height: 120%;"></canvas>
        <div class="button-container">
        <button id="gatherButton" class="game-button">Gather Board</button>
        <button id="companionsButton" class="game-button">Choose Companions</button>
        <button id="discardPileButton" class="game-button">View Discard</button>
        <button id="moveButton" class="game-button">Move To Next Site</button>
        <button id="addBurdenButton" class="game-button">Add Burden</button>
    </div>

    <h2>Twilight</h2>
    <div class="twilight-container">
        <button id="twilightUp" class="arrow-button arrow-up">▲</button>
        <div id="twlightCounter">0</div>
        <button id="twilightDown" class="arrow-button arrow-down">▼</button>
    </div>
    <div id="gameLogContainer">
        <button onclick="toggleGameLog()">Game Log</button>
        <div id="gameLog" class="hidden"></div>
    </div>
   
    <script type="module" src="canvas.js"></script>
    <!-- This sends data back to my server. -->
    <script src="/socket.io/socket.io.js"></script>
    <script>

        function joinGame(gameId, playerName) {
            console.log("Joining game from table gameID: %d", gameId);
            socket.emit('joinGame', gameId, playerName);
        }

        function showWaitingPopup() {
            const popup = document.getElementById('waitingPopup');
            popup.style.display = 'flex'; // Show the popup
        }
        function hideWaitingPopup() {
            const popup = document.getElementById('waitingPopup');
            popup.style.display = 'none'; // Hide the popup
        }
        function startGame() {
            hideWaitingPopup();
            setTimeout(() => {
                console.log("Sending gameStarted");
                document.dispatchEvent(new CustomEvent("gameStarted", { detail: "none" }));
            }, 1000);
        }

        function toggleGameLog() {
            const log = document.getElementById('gameLog');
            log.classList.toggle('hidden');
        }

        const socket = io();

        document.fonts.load('20px ElvenCommon');

        // Listen for events from the server
        socket.on('gameJoined', (data) => {
            gameId = data.gameId
            numPlayers = data.numPlayersInLobby
            console.log('Successfully joined gameID: %d, numPlayers:%d', gameId, numPlayers);
            if (numPlayers >= 2) {
                console.log("Another player is already here, lets start")
                startGame();
            }
        });

        let gameID = sessionStorage.getItem("gameID");
        let playerName = sessionStorage.getItem("playerName");

        joinGame(gameID, playerName);

        showWaitingPopup();

        // incoming events.
        socket.on('playerJoined', (playerName) => {
            console.log(`${playerName} has joined the game.`);
            const opponentNameHeading = document.getElementById("opponentNameHeading")
            opponentNameHeading.innerText = "Opponent:" + playerName;
            event = { "playerName": playerName }
            document.dispatchEvent(new CustomEvent("playerJoined", event));
            startGame();
        });

        socket.on('cardEvent', (eventData) => {
            document.dispatchEvent(new CustomEvent("remoteCardEvent", { detail: eventData }));
        });

        socket.on('gameEvent', (eventData) => {
            document.dispatchEvent(new CustomEvent("remoteGameEvent", { detail: eventData }));
        })

        socket.on('playerLeft', (socketId) => {
            console.log(`Player with socketId ${socketId} has left the game.`);
        });

        // Events from the client game.
        document.addEventListener('cardEvent', (msg) => {
            console.log("Got a card event info: %s", JSON.stringify(msg.detail, 2, null))
            socket.emit('cardEvent', msg.detail)
        })

        document.addEventListener('gameEvent', (msg) => {
            console.log("Forwarding gameEvent: %s", JSON.stringify(msg.detail, 2, null))
            socket.emit('gameEvent', msg.detail)
        })
    </script>

</body>

</html>